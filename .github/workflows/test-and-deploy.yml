name: Test & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test API
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify data file exists
      run: |
        if [ ! -f "api/data.json" ]; then
          echo "Error: api/data.json not found!"
          exit 1
        fi
        echo "Data file found"
    
    - name: Validate JSON
      run: |
        python -c "import json; json.load(open('api/data.json', encoding='utf-8'))"
        echo "Data file is valid JSON"
    
    - name: Run data tests
      run: |
        python api/test_api.py
    
    - name: Start API server
      run: |
        cd api
        python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
        sleep 5
    
    - name: Test health endpoint
      run: |
        response=$(curl -s http://localhost:8000/health)
        echo "Health: $response"
        echo "$response" | grep -q "healthy" || (echo "Health check failed" && exit 1)
        echo "Health check passed"
    
    - name: Test levels endpoint
      run: |
        response=$(curl -s http://localhost:8000/api/v1/levels)
        echo "$response" | grep -q "success" || (echo "Levels endpoint failed" && exit 1)
        echo "Levels endpoint passed"
    
    - name: Test subjects endpoint
      run: |
        response=$(curl -s http://localhost:8000/api/v1/subjects)
        echo "$response" | grep -q "success" || (echo "Subjects endpoint failed" && exit 1)
        echo "Subjects endpoint passed"
    
    - name: Test content endpoint
      run: |
        response=$(curl -s http://localhost:8000/api/v1/content?limit=5)
        echo "$response" | grep -q "success" || (echo "Content endpoint failed" && exit 1)
        echo "Content endpoint passed"
    
    - name: Test search endpoint
      run: |
        response=$(curl -s "http://localhost:8000/api/v1/search?q=math")
        echo "$response" | grep -q "success" || (echo "Search endpoint failed" && exit 1)
        echo "Search endpoint passed"
    
    - name: Test stats endpoint
      run: |
        response=$(curl -s http://localhost:8000/api/v1/stats)
        echo "$response" | grep -q "success" || (echo "Stats endpoint failed" && exit 1)
        echo "Stats endpoint passed"
    
    - name: Summary
      if: success()
      run: |
        echo "================================"
        echo "ALL TESTS PASSED!"
        echo "================================"
        echo "- Data file valid"
        echo "- All API endpoints working"
        echo "- Ready for deployment"
        echo "================================"

  deploy:
    name: Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deployment notification
      run: |
        echo "Tests passed - Railway will auto-deploy from GitHub"
        echo "Check Railway dashboard: https://railway.app/dashboard"
