name: Test & Deploy to Railway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx
    
    - name: Verify data file exists
      run: |
        if [ ! -f "api/data.json" ]; then
          echo "‚ùå Error: api/data.json not found!"
          exit 1
        fi
        echo "‚úÖ Data file found"
    
    - name: Check data file is valid JSON
      run: |
        python -c "import json; json.load(open('api/data.json'))"
        echo "‚úÖ Data file is valid JSON"
    
    - name: Verify data quality
      run: |
        python << 'EOF'
        import json
        
        with open('api/data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # Check required fields
        assert 'source' in data, "Missing 'source' field"
        assert data['source'] == 'public_website', f"Source should be 'public_website', got '{data['source']}'"
        
        assert 'levels' in data, "Missing 'levels' field"
        assert 'subjects' in data, "Missing 'subjects' field"
        
        # Check data counts
        levels_count = len(data['levels'])
        subjects_count = len(data['subjects'])
        
        assert levels_count > 0, "No levels found"
        assert subjects_count > 0, "No subjects found"
        
        print(f"‚úÖ Data validation passed:")
        print(f"   - Source: {data['source']}")
        print(f"   - Levels: {levels_count}")
        print(f"   - Subjects: {subjects_count}")
        print(f"   - Total items: {levels_count + subjects_count}")
        EOF
    
    - name: Start API server
      run: |
        cd api
        python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
        sleep 5
    
    - name: Test API endpoints
      run: |
        # Test health endpoint
        response=$(curl -s http://localhost:8000/health)
        echo "Health: $response"
        if ! echo "$response" | grep -q "healthy"; then
          echo "‚ùå Health check failed"
          exit 1
        fi
        echo "‚úÖ Health check passed"
        
        # Test API info
        response=$(curl -s http://localhost:8000/)
        echo "API Info: $response"
        if ! echo "$response" | grep -q "Moroccan Education"; then
          echo "‚ùå API info failed"
          exit 1
        fi
        echo "‚úÖ API info passed"
        
        # Test levels endpoint
        response=$(curl -s http://localhost:8000/api/v1/levels)
        if ! echo "$response" | grep -q "success"; then
          echo "‚ùå Levels endpoint failed"
          exit 1
        fi
        echo "‚úÖ Levels endpoint passed"
        
        # Test subjects endpoint
        response=$(curl -s http://localhost:8000/api/v1/subjects)
        if ! echo "$response" | grep -q "success"; then
          echo "‚ùå Subjects endpoint failed"
          exit 1
        fi
        echo "‚úÖ Subjects endpoint passed"
        
        # Test stats endpoint
        response=$(curl -s http://localhost:8000/api/v1/stats)
        if ! echo "$response" | grep -q "success"; then
          echo "‚ùå Stats endpoint failed"
          exit 1
        fi
        echo "‚úÖ Stats endpoint passed"
        
        # Test search endpoint
        response=$(curl -s "http://localhost:8000/api/v1/search?q=math")
        if ! echo "$response" | grep -q "success"; then
          echo "‚ùå Search endpoint failed"
          exit 1
        fi
        echo "‚úÖ Search endpoint passed"
    
    - name: Run API tests
      run: |
        cd api
        python test_api.py
    
    - name: Check for private data
      run: |
        python << 'EOF'
        import json
        import re
        
        with open('api/data.json', 'r', encoding='utf-8') as f:
            data_str = f.read()
            data = json.loads(data_str)
        
        # Check source is generic
        assert data['source'] == 'public_website', "Source must be 'public_website'"
        
        # Check for email addresses
        if re.search(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', data_str):
            print("‚ùå Warning: Possible email addresses found")
            exit(1)
        
        # Check for phone numbers
        if re.search(r'\+?\d{10,}', data_str):
            print("‚ùå Warning: Possible phone numbers found")
            exit(1)
        
        print("‚úÖ Privacy check passed - no private data detected")
        EOF
    
    - name: Summary
      if: success()
      run: |
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "‚úÖ ALL TESTS PASSED!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "‚úÖ Data file valid"
        echo "‚úÖ Data quality verified"
        echo "‚úÖ All API endpoints working"
        echo "‚úÖ API tests passed"
        echo "‚úÖ No private data detected"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üöÄ Ready for Railway deployment!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  deploy:
    name: Deploy to Railway
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deployment notification
      run: |
        echo "‚úÖ Tests passed - Railway will auto-deploy from GitHub"
        echo "üöÇ Check Railway dashboard: https://railway.app/dashboard"

